const CACHE_NAME="story-app-v4",API_BASE="https://story-api.dicoding.dev/v1",STATIC_ASSETS=["/","/index.html","/manifest.webmanifest","/icons/checklist.png","/icons/book.png","/src/app.js","/src/app.css"],RUNTIME_CACHE="story-runtime-v1",OSM_TILE_CACHE="osm-tiles-v1";async function syncOfflineStories(){const t=await openDB(),e=t.transaction("offline-stories","readonly"),n=e.objectStore?e.objectStore("offline-stories"):null;if(!n)return;const s=n.getAll?n.getAll():null;if(!s)return;const o=await new Promise(t=>{s.onsuccess=()=>t(s.result||[]),s.onerror=()=>t([])});for(const e of o)try{await fetch(`${API_BASE}/stories`,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}}),t.transaction("offline-stories","readwrite").objectStore("offline-stories").delete(e.id)}catch(t){console.error("Sync failed:",t)}}function openDB(){return new Promise((t,e)=>{const n=indexedDB.open("story-app-db",1);n.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains("offline-stories")||e.createObjectStore("offline-stories",{keyPath:"id"})},n.onsuccess=e=>t(e.target.result),n.onerror=t=>e(t.target.error)})}self.addEventListener("install",t=>{t.waitUntil(caches.open(CACHE_NAME).then(t=>t.addAll(STATIC_ASSETS))),self.skipWaiting()}),self.addEventListener("activate",t=>{t.waitUntil(caches.keys().then(t=>Promise.all(t.map(t=>t!==CACHE_NAME&&t!==RUNTIME_CACHE&&"osm-tiles-v1"!==t?caches.delete(t):Promise.resolve())))),self.clients.claim()}),self.addEventListener("fetch",t=>{const{request:e}=t;new URL(e.url),e.url.includes("tile.openstreetmap.org")?t.respondWith(caches.open("osm-tiles-v1").then(async t=>{const n=await t.match(e);if(n)return n;try{const n=await fetch(e);return n&&200===n.status&&t.put(e,n.clone()),n}catch(t){return await caches.match("/icons/location.png")||new Response("",{status:503,statusText:"Offline"})}})):e.url.startsWith(API_BASE)?t.respondWith(fetch(e).then(t=>{const n=t.clone();return caches.open(RUNTIME_CACHE).then(t=>t.put(e,n)),t}).catch(async()=>await caches.match(e)||new Response(JSON.stringify({error:!0,message:"offline"}),{headers:{"Content-Type":"application/json"}}))):t.respondWith(caches.match(e).then(t=>t||fetch(e).catch(()=>"navigate"===e.mode?caches.match("/index.html"):new Response("",{status:503,statusText:"Offline"}))))}),self.addEventListener("push",t=>{let e={title:"Story Notification",options:{body:"Ada pembaruan story baru!",icon:"/icons/checklist.png",badge:"/icons/badge_notif.png",vibrate:[200,100,200]}};if(t.data)try{const n=t.data.json();e.title=n.title||e.title,e.options.body=n.body||e.options.body,n.icon&&(e.options.icon=n.icon),n.url&&(e.options.data={url:n.url})}catch{e.options.body=t.data.text()}t.waitUntil(self.registration.showNotification(e.title,e.options))}),self.addEventListener("notificationclick",t=>{t.notification.close();const e=t.notification.data?.url||"/#/home";t.waitUntil(clients.openWindow(e))}),self.addEventListener("sync",async t=>{"sync-new-story"===t.tag&&t.waitUntil(syncOfflineStories())});