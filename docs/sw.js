const CACHE_NAME="story-app-shell-v7",RUNTIME_CACHE="story-runtime-v3",OSM_TILE_CACHE="osm-tiles-v1",API_BASE="https://story-api.dicoding.dev/v1",STATIC_ASSETS=["/","/index.html","/manifest.webmanifest","/icons/checklist.png","/icons/book.png","/app.css"];async function networkFirstWithTimeout(t,e=2500){const n=new Promise((t,n)=>setTimeout(()=>n(new Error("timeout")),e));try{const e=await Promise.race([fetch(t),n]);if(e&&e.ok)try{const n=e.clone();(await caches.open(RUNTIME_CACHE)).put(t,n)}catch(t){console.warn("[SW] cache.put failed:",t)}return e}catch{const e=await caches.open(RUNTIME_CACHE);return await e.match(t)||new Response(JSON.stringify({error:!0,message:"offline"}),{headers:{"Content-Type":"application/json"}})}}self.addEventListener("install",t=>{t.waitUntil(caches.open(CACHE_NAME).then(t=>t.addAll(STATIC_ASSETS))),self.skipWaiting()}),self.addEventListener("activate",t=>{t.waitUntil((async()=>{const t=await caches.keys();await Promise.all(t.map(t=>{if(![CACHE_NAME,RUNTIME_CACHE,OSM_TILE_CACHE].includes(t))return caches.delete(t)})),self.registration.navigationPreload&&await self.registration.navigationPreload.enable()})()),self.clients.claim()}),self.addEventListener("fetch",t=>{const e=t.request;"GET"===e.method&&(e.url.includes("tile.openstreetmap.org")?t.respondWith(caches.open(OSM_TILE_CACHE).then(async t=>{const n=await t.match(e);if(n)return n;try{const n=await fetch(e);return n.ok&&t.put(e,n.clone()),n}catch{return await caches.match("/icons/location.png")||new Response("",{status:503,statusText:"Offline"})}})):e.url.startsWith(API_BASE)?t.respondWith(networkFirstWithTimeout(e,2500)):"navigate"!==e.mode?t.respondWith(caches.match(e).then(t=>t||fetch(e).then(t=>{try{if(t.ok&&!t.bodyUsed&&new URL(e.url).origin===self.location.origin&&e.headers.get("accept")&&!e.headers.get("accept").includes("text/html")){const n=t.clone();caches.open(RUNTIME_CACHE).then(t=>t.put(e,n))}}catch(t){console.warn("[SW] static cache clone failed:",t)}return t}).catch(()=>new Response("",{status:503,statusText:"Offline"})))):t.respondWith((async()=>{const n=await caches.open(CACHE_NAME),i=await n.match("/index.html"),o=await t.preloadResponse;if(o){try{n.put("/index.html",o.clone())}catch(t){console.warn("[SW] preload clone fail:",t)}return o}return fetch(e).then(t=>{if(t.ok&&!t.bodyUsed)try{n.put("/index.html",t.clone()),self.clients.matchAll({includeUncontrolled:!0}).then(t=>{for(const e of t)e.postMessage({type:"NEW_VERSION_AVAILABLE"})})}catch(t){console.warn("[SW] index.html clone fail:",t)}}).catch(()=>{}),i||await fetch(e).catch(()=>new Response("<h1>Offline</h1>",{headers:{"Content-Type":"text/html"}}))})()))}),self.addEventListener("push",t=>{let e={title:"Story Notification",options:{body:"Ada pembaruan story baru!",icon:"/icons/checklist.png",badge:"/icons/checklist.png",vibrate:[200,100,200],data:{url:"/#/home"}}};if(t.data)try{const n=t.data.json();e.title=n.title||e.title,e.options.body=n.body||e.options.body,n.icon&&(e.options.icon=n.icon),n.url&&(e.options.data={url:n.url})}catch{e.options.body=t.data.text()}t.waitUntil(self.registration.showNotification(e.title,e.options))}),self.addEventListener("notificationclick",t=>{t.notification.close();const e=t.notification.data?.url||"/#/home";t.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then(t=>{for(const n of t)if(n.url.includes("/")&&"focus"in n)return n.focus(),void n.postMessage({type:"navigate",url:e});return clients.openWindow(e)}))});