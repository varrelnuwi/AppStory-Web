export async function registerServiceWorker(){if("serviceWorker"in navigator)try{const t=await navigator.serviceWorker.register("./sw.js");if(console.log("‚úÖ Service Worker registered:",t),t.active&&"redundant"===t.active.state)return console.warn("‚ö†Ô∏è SW redundant detected. Unregistering old version..."),await t.unregister(),void window.location.reload();await waitUntilActive(t),t.onupdatefound=()=>console.log("üîÅ Service Worker update found"),setupPushToggle(t),setupOnlineStatus()}catch(t){console.warn("‚ùå SW registration failed:",t)}}async function waitUntilActive(t){t.active||await new Promise(e=>{const n=setInterval(()=>{t.active&&(clearInterval(n),e())},300)})}async function setupPushToggle(t){let e;for(let t=0;t<20&&(e=document.getElementById("pushToggle"),!e);t++)await new Promise(t=>setTimeout(t,300));if(!e)return void console.warn("‚ö†Ô∏è pushToggle button not found in DOM");"default"===Notification.permission&&await Notification.requestPermission();const n=await t.pushManager.getSubscription();let i=!!n;updateButtonUI(e,i),e.onclick=async()=>{try{const o=localStorage.getItem("token");if(!o)return void alert("Silakan login terlebih dahulu sebelum mengaktifkan notifikasi.");if(i&&n)await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"DELETE",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({endpoint:n.endpoint})}),await n.unsubscribe(),i=!1,updateButtonUI(e,i),alert("Push notification disabled");else{const n=urlBase64ToUint8Array("BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk"),a=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:n});await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({endpoint:a.endpoint,keys:a.toJSON().keys})}),console.log("üì¨ Subscription sent to Dicoding:",a),i=!0,updateButtonUI(e,i),t.showNotification("Push Aktif üéâ",{body:"Push notification berhasil diaktifkan!",icon:"./icons/checklist.png"})}}catch(t){console.error("‚ùå Push toggle failed:",t),alert("Gagal mengubah status push notification.")}}}function updateButtonUI(t,e){localStorage.setItem("pushEnabled",e?"true":"false"),t.textContent=e?"üîî Notifikasi ON":"üîï Notifikasi OFF",t.className=e?"btn-alt active":"btn-alt"}function urlBase64ToUint8Array(t){const e=(t+"=".repeat((4-t.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),n=atob(e),i=new Uint8Array(n.length);for(let t=0;t<n.length;++t)i[t]=n.charCodeAt(t);return i}function setupOnlineStatus(){const t=document.getElementById("networkStatus");if(!t)return;const e=()=>{const e=navigator.onLine;t.textContent=e?"üü¢ Online":"üî¥ Offline",t.style.color=e?"green":"red"};window.addEventListener("online",e),window.addEventListener("offline",e),e()}registerServiceWorker();