export async function registerServiceWorker(){if("serviceWorker"in navigator)try{const e=await navigator.serviceWorker.register("./sw.js");if(console.log("âœ… Service Worker registered:",e),e.active&&"redundant"===e.active.state)return console.warn("âš ï¸ SW redundant detected. Unregistering old version..."),await e.unregister(),void window.location.reload();await waitUntilActive(e),e.onupdatefound=()=>{console.log("ğŸ” Service Worker update found")},setupPushToggle(e),setupOnlineStatus()}catch(e){console.warn("âŒ SW registration failed:",e)}}async function waitUntilActive(e){e.active||await new Promise(t=>{const n=setInterval(()=>{e.active&&(clearInterval(n),t())},300)})}async function setupPushToggle(e){let t;for(let e=0;e<20&&(t=document.getElementById("pushToggle"),!t);e++)await new Promise(e=>setTimeout(e,300));if(!t)return void console.warn("âš ï¸ pushToggle button not found in DOM");"default"===Notification.permission&&await Notification.requestPermission();const n=await e.pushManager.getSubscription();let i=!!n;updateButtonUI(t,i),t.onclick=async()=>{try{if(i&&n)await n.unsubscribe(),i=!1,updateButtonUI(t,i),alert("Push notification disabled");else{const n=urlBase64ToUint8Array("BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk"),o=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:n});console.log("ğŸ“¬ New Push Subscription:",o),i=!0,updateButtonUI(t,i),e.showNotification("Push Aktif ğŸ‰",{body:"Push notification berhasil diaktifkan!",icon:"./icons/checklist.png"})}}catch(e){console.error("âŒ Push toggle failed:",e),alert("Gagal mengubah status push notification.")}}}function updateButtonUI(e,t){localStorage.setItem("pushEnabled",t?"true":"false"),e.textContent=t?"ğŸ”” Notifikasi ON":"ğŸ”• Notifikasi OFF",e.className=t?"btn-alt active":"btn-alt"}function urlBase64ToUint8Array(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),n=atob(t),i=new Uint8Array(n.length);for(let e=0;e<n.length;++e)i[e]=n.charCodeAt(e);return i}function setupOnlineStatus(){const e=document.getElementById("networkStatus");if(!e)return;const t=()=>{const t=navigator.onLine;e.textContent=t?"ğŸŸ¢ Online":"ğŸ”´ Offline",e.style.color=t?"green":"red"};window.addEventListener("online",t),window.addEventListener("offline",t),t()}registerServiceWorker();